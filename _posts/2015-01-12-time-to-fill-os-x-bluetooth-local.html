---
layout: post
title: 'Time to fill OS X (Blue)tooth: Local privilege escalation vulnerabilities
  in Yosemite'
date: '2015-01-12T06:59:00.001-08:00'
author: aristide_fattori
tags:
- CVE-2014-8837
- pwn
- Yosemite
- privilege
- vulnerability
- exploit
- Mac OS X
- LPE
- escalation
modified_time: '2015-02-08T02:59:49.855-08:00'
thumbnail: http://1.bp.blogspot.com/-LtP_d9wlSwM/VLKVpHSa0lI/AAAAAAAAFl0/_aWqK6pAt48/s72-c/IOBluetoothFamily_10.10.1_bcopy.png
blogger_id: tag:blogger.com,1999:blog-7491184756351885467.post-7757486599954052892
blogger_orig_url: http://joystick.artificialstudios.org/2015/01/time-to-fill-os-x-bluetooth-local.html
---

<div style="text-align: justify;"><div style="text-align: right;"><div style="background-color: #fefdfa; color: #333333; font-family: Arial, Tahoma, Helvetica, FreeSans, sans-serif; font-size: 13px; line-height: 18.2000007629395px;"><span style="color: #999999;">(This post is a joint work with&nbsp;<a href="https://twitter.com/rpaleari" style="color: #7d181e; text-decoration: none;">@rpaleari</a>, see also his blog&nbsp;<a href="http://randomthoughts.greyhats.it/" style="color: #7d181e; text-decoration: none;">here</a>)</span></div><div><span style="color: #999999;"><br /></span></div></div>Motivated by our <a href="http://joystick.artificialstudios.org/2014/10/mac-os-x-local-privilege-escalation.html" target="_blank">previous findings</a>, we performed some more tests on service <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">IOBluetoothHCIController</span> of the latest version of Mac OS X (Yosemite 10.10.1), and we found five additional security issues. The issues have been reported to Apple Security and, since the deadline we agreed upon with them expired, we now disclose details &amp; PoCs for four of them<span style="font-family: &quot;Courier New&quot;,Courier,monospace;"> (</span>the last one was notified few days later and is still under investigation by Apple). All the issues are in class <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">IOBluetoothHCIController</span>, implemented in the <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">IOBluetoothFamily</span> kext (md5 <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">e4123caff1b90b81d52d43f9c47fec8f</span>).<br /><br /><h3>Issue 1 (<span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><a href="http://goo.gl/8i2y5k" target="_blank">crash-issue1.c</a></span>)</h3>Many callback routines handled by <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">IOBluetoothHCIController</span> blindly dereference pointer arguments without checking them. The caller of these callbacks, <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">IOBluetoothHCIUserClient::SimpleDispatchWL()</span>, may actually pass NULL pointers, that are eventually dereferenced. <br /><br />More precisely, every user-space argument handled by <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">SimpleDispatchWL()</span> consists of a <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">value</span> and a <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">size</span> field (see <a href="http://goo.gl/8i2y5k" target="_blank"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">crash-issue1.c</span></a> for details). When a user-space client provides an argument with a NULL <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">value</span> but a large <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">size</span>, a subsequent call to <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">IOMalloc(size)</span> fails, returning a NULL pointer that is eventually passed to callees, causing the NULL pointer dereference. <br /><br />The PoC we provide targets method <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">DispatchHCICreateConnection()</span>, but the very same approach can be used to cause a kernel crash using other callback routines (basically any other callback that receives one or more pointer arguments). At first, we ruled out this issue as a mere local DoS. However, as discussed <a href="https://code.google.com/p/google-security-research/issues/detail?id=20" target="_blank">here</a>, Yosemite only partially prevents mapping the NULL page from user-space, so it is still possible to exploit NULL pointer dereferences to mount LPE attacks. For instance, the following code can be used to map page zero: <br /><br /><div style="margin-left: 1.5em;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">Mac:tmp $ cat zeropage.c</span> <!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; overflow: auto; padding: .2em .6em; width: auto;"><table><tbody><tr><td></td><td><pre style="line-height: 125%; margin: 0;"><span style="color: #557799;">#include &lt;mach/mach.h&gt;</span><br /><span style="color: #557799;">#include &lt;mach/mach_vm.h&gt;</span><br /><span style="color: #557799;">#include &lt;mach/vm_map.h&gt;</span><br /><span style="color: #557799;">#include &lt;stdio.h&gt;</span><br /><br /><span style="color: #333399; font-weight: bold;">int</span> <span style="color: #0066bb; font-weight: bold;">main</span>(<span style="color: #333399; font-weight: bold;">int</span> argc, <span style="color: #333399; font-weight: bold;">char</span> <span style="color: #333333;">**</span>argv)<br />{<br />  <span style="color: #333399; font-weight: bold;">mach_vm_address_t</span> addr <span style="color: #333333;">=</span> <span style="color: #0000dd; font-weight: bold;">0</span>;<br />  vm_deallocate(mach_task_self(), <span style="color: #005588; font-weight: bold;">0x0</span>, <span style="color: #005588; font-weight: bold;">0x1000</span>);<br />  <span style="color: #333399; font-weight: bold;">int</span> r <span style="color: #333333;">=</span> mach_vm_allocate(mach_task_self(), <span style="color: #333333;">&amp;</span>addr, <span style="color: #005588; font-weight: bold;">0x1000</span>, <span style="color: #0000dd; font-weight: bold;">0</span>);<br />  printf("%08llx %d\n", addr, r);<br />  <span style="color: #333333;">*</span>((<span style="color: #333399; font-weight: bold;">uint32_t</span> <span style="color: #333333;">*</span>)addr) <span style="color: #333333;">=</span> <span style="color: #005588; font-weight: bold;">0x41414141</span>;<br />  printf("%08x\n", <span style="color: #333333;">*</span>((<span style="color: #333399; font-weight: bold;">uint32_t</span> <span style="color: #333333;">*</span>)addr));<br />}<br /></pre></td></tr></tbody></table></div><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">Mac:tmp $ llvm-gcc -Wall -o zeropage{,.c} -Wl,-pagezero_size,0  -m32 </span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">Mac:tmp $ ./zeropage </span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">00000000 0 </span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">41414141 </span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">Mac:tmp $</span></div><br />Trying the same without the <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">-m32</span> flag results in the 64-bit Mach-O being blocked at load time by the OS with message "<i>Cannot enforce a hard page-zero for ./zeropage</i>" (unless you do it as "<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">root</span>", but then whatâ€™s the point?). <br /><br /><h3>Issue 2 (<span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><a href="http://goo.gl/teK3lo" target="_blank">crash-issue2.c</a></span>)</h3>As shown in the screenshot below, <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">IOBluetoothHCIController::BluetoothHCIChangeLocalName()</span> is affected by an "old-school" stack-based buffer overflow, due to a <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">bcopy(src, dest, strlen(src))</span> call where <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">src</span> is fully controlled by the attacker. To the best of our knowledge, this bug cannot be directly exploited due to the existing stack canary protection. However, it may still be useful to mount a LPE attack if used in conjunction with a memory leak vulnerability, leveraged to disclose the canary value. <br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://1.bp.blogspot.com/-LtP_d9wlSwM/VLKVpHSa0lI/AAAAAAAAFl0/_aWqK6pAt48/s1600/IOBluetoothFamily_10.10.1_bcopy.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="http://1.bp.blogspot.com/-LtP_d9wlSwM/VLKVpHSa0lI/AAAAAAAAFl0/_aWqK6pAt48/s1600/IOBluetoothFamily_10.10.1_bcopy.png" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Issue 2, a plain stack-based buffer overflow</td></tr></tbody></table><br /><h3>Issue 3 (<span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><a href="http://goo.gl/q0fRLo" target="_blank">crash-issue3.c</a></span>)</h3><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">IOBluetoothHCIController::TransferACLPacketToHW()</span> receives as an input parameter a pointer to an <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">IOMemoryDescriptor</span> object. The function carefully checks that the supplied pointer is non-NULL; however, regardless of the outcome of this test, it then dereferences the pointer (see the figure below, the attacker-controlled input parameter is stored in register <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">r15</span>). The <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">IOMemoryDescriptor</span> object is created by the caller (<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">DispatchHCISendRawACLData()</span>) using the <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">IOMemoryDescriptor::withAddress()</span> constructor. As this constructor is provided with a user-controlled value, it may fail and return a NULL pointer. See Issue 1 discussion regarding the exploitability of NULL pointer dereferences on Yosemite.<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://1.bp.blogspot.com/-4o45NXBU7pQ/VLKWtMTVkMI/AAAAAAAAFmA/7_KGexL4jBo/s1600/IOBluetoothFamily_10.10.1_null.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="http://1.bp.blogspot.com/-4o45NXBU7pQ/VLKWtMTVkMI/AAAAAAAAFmA/7_KGexL4jBo/s1600/IOBluetoothFamily_10.10.1_null.png" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Issue 3, the module checks if <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">r15</span> is NULL, but dereferences it anyway</td></tr></tbody></table><br /><h3>Issue 4 (<span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><a href="http://goo.gl/EVTTND" target="_blank">lpe-issue1.c</a></span>)</h3>In this case, the problem is due to a missing sanity check on the arguments of the following function: <br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; overflow: auto; padding: .2em .6em; width: auto;"><pre style="line-height: 125%; margin: 0;">IOReturn <span style="color: #0066bb; font-weight: bold;">BluetoothHCIWriteStoredLinkKey</span>(<br />      <span style="color: #333399; font-weight: bold;">uint32_t</span> req_index,<br />      <span style="color: #333399; font-weight: bold;">uint32_t</span> num_of_keys,<br />      BluetoothDeviceAddress <span style="color: #333333;">*</span>p_device_addresses,<br />      BluetoothKey <span style="color: #333333;">*</span>p_bluetooth_keys,<br />      BluetoothHCINumLinkKeysToWrite <span style="color: #333333;">*</span>outNumKeysWritten);<br /></pre></div><br />The first parameter, <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">req_index</span>, is used to find an HCI Request in the queue of allocated HCI Requests (thus this exploit requires first to fill this queue with possibly fake requests). The second integer parameter (<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">num_of_keys</span>) is used to calculate the total size of the other inputs, respectively pointed by <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">p_device_addresses</span> and <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">p_bluetooth_keys</span>. As shown in the screenshot below, these values are <b>not</b> checked before being passed to function <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">IOBluetoothHCIController::SendHCIRequestFormatted()</span>, which has the following prototype: <br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; overflow: auto; padding: .2em .6em; width: auto;"><pre style="line-height: 125%; margin: 0;">IOReturn <span style="color: #0066bb; font-weight: bold;">SendHCIRequestFormatted</span>(<span style="color: #333399; font-weight: bold;">uint32_t</span> req_index, <span style="color: #333399; font-weight: bold;">uint16_t</span> inOpCode,<br />     <span style="color: #333399; font-weight: bold;">uint64_t</span> outResultsSize,<br />     <span style="color: #333399; font-weight: bold;">void</span> <span style="color: #333333;">*</span>outResultBuf,<br />     <span style="color: #008800; font-weight: bold;">const</span> <span style="color: #333399; font-weight: bold;">char</span> <span style="color: #333333;">*</span>inFormat, ...);<br /></pre></div><br /><br /><div class="separator" style="clear: both; text-align: center;"></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://3.bp.blogspot.com/-ZJdi_uT1GYo/VLKYlMrUAkI/AAAAAAAAFmU/q7nD4eGPZRc/s1600/writestoredlinkkey.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="http://3.bp.blogspot.com/-ZJdi_uT1GYo/VLKYlMrUAkI/AAAAAAAAFmU/q7nD4eGPZRc/s1600/writestoredlinkkey.png" height="640" width="579" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Issue 4, an exploitable buffer overflow</td></tr></tbody></table><br />The passed format string "<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">HbbNN</span>" will eventually cause&nbsp;<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">size_of_addresses</span>&nbsp;bytes to be copied from&nbsp;<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">p_device_addresses</span>&nbsp;to the HCI request object identified by&nbsp;<span style="font-family: Courier New, Courier, monospace;">req_index</span>&nbsp;in reverse order (the '<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">N</span>' format consumes two arguments, the first is a size, the second a pointer to read from). If the calculated&nbsp;<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">size_of_addresses</span>&nbsp;is big enough (i.e., if we provide a big enough&nbsp;<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">num_of_keys</span>&nbsp;parameter), the copy overflows the buffer of the request, thrashing everything above it, including a number of function pointers in the vtable of the request object. These pointers are overwritten with attacker-controlled data (i.e., those pointed by&nbsp;<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">p_bluetooth_keys</span>) and called before returning to userspace, thus we can divert the execution wherever we want.<br /><br />As a PoC, <a href="http://goo.gl/EVTTND" target="_blank"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">lpe-issue1.c</span></a> exploits this bug and attempts to call a function located at the attacker-controller address <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">0x4141414142424242</span>. Please note that the attached PoC requires some more tuning before it can cleanly return to user-space, since more than one vtable pointer is corrupted during the overflow and needs to be fixed with valid pointers.<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://3.bp.blogspot.com/-x_Nzfz8sHUU/VLKYe0QYLfI/AAAAAAAAFmM/P04WOnKIBfI/s1600/shell.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="http://3.bp.blogspot.com/-x_Nzfz8sHUU/VLKYe0QYLfI/AAAAAAAAFmM/P04WOnKIBfI/s1600/shell.png" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Execution of our "proof-of-concept" exploit (Issue 4)</td></tr></tbody></table><br /><h3>Notes</h3>All the PoCs we provide in this post are not "weaponized", i.e., they do not contain a real payload, nor they attempt to bypass existing security features of Yosemite (e.g., kASLR and SMEP). If youâ€™re interested in bypass techniques (as you probably are, if you made it here), Ian Beer of Google Project Zero covered pretty much all of it in a very thorough <a href="http://googleprojectzero.blogspot.it/2014/11/pwn4fun-spring-2014-safari-part-ii.html" target="_blank">blog post</a>. In this case, he used a leak in the IOKit registry to calculate <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">kslide</span> and defeat kASLR, while he used an in-kernel ROP-chain to bypass SMEP. More recently, <a href="https://twitter.com/i0n1c" target="_blank">@i0n1c</a> posted <a href="https://www.sektioneins.de/en/blog/14-12-23-mach_port_kobject.html" target="_blank">here</a> about how kASLR is fundamentally broken on Mac OS X at the moment. <br /><br /><h3>Conclusions</h3>Along the last issue identified, we shared with Apple our conclusions on this kext: according to the issues we identified, we speculate there are many other crashes and LPE vulnerabilities in it. Ours, however, is just a best-effort analysis done in our spare time, and given the very small effort that took us to identify the vulnerabilities, we would suggest a serious security evaluation of the whole kext code. <br /><br /><h3>Disclosure timeline</h3><ul><li><b>02/11</b>: Notification of issues 1, 2 and 3.</li><li><b>23/11</b>: No answer received from Apple, notification of issue 4. As no answer was received since the first contact, propose December 2 as possible disclosure date.</li><li><b>25/11</b>: Apple answers requesting more time. We propose to move the disclosure date to January 12.</li><li><b>27/11</b>: Apple accepts the new deadline.</li><li><b>05/12</b>: Contact Apple asking for the status of the vulnerabilities.</li><li><b>06/12</b>: Apple says they're still "investigating the issue".</li><li><b>23/12</b>: Notification of a new issue (#5), proposing January 23 as a tentative disclosure date.</li><li><b>06/01</b>: Apple asks for more time for issue #5. We propose to move the disclosure date to February 23. We remind our intention to disclose the 4 previous issues on January 12.</li><li><b>12/01</b>: No answer from Apple, disclosing first 4 issues.</li><li style="text-align: left;"><b>27/01</b>: Apple assigned our issues <b>CVE-2014-8837</b> and<span style="color: #333333; font-family: Myriad Set Pro, Helvetica Neue, Helvetica, Arial, Verdana, sans-serif;"><span style="background-color: white; font-size: 18px; line-height: 26.1000003814697px;">&nbsp;</span></span>patched all of them in Mac OS X 10.10.2.</li></ul><br /></div>
